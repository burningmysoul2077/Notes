# InternLM 模型全链条开源

# InternLM 模型

>   `InternLM` 是一个开源的轻量级训练框架。
>   旨在 _支持大模型训练而无需大量的依赖_。

-  基于 InternLM 训练框架，_上海人工智能实验室_ 已经发布了两个开源的预训练模型：
	-  InternLM-7B
	-  InternLM-20B

## Lagent

>  `Lagent` 是一个轻量级、开源的基于大语言模型的 __智能体 agent__ 框架。
>   支持用户快速将一个大预言模型转变为多种类型的智能体，并提供了一些典型工具。

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106155421.png)

## 浦语灵笔

>  `浦语·灵笔` 是基于书生·浦语大语言模型研发的视觉-语言大模型。
>  提供出色的图文理解和创作能力，结合了视觉和语言的先进技术，能够实现图像到文本、文本到图像的双向转换。

---

# 创建 InternLM-Chat-7B Demo

## 环境准备

-  InternStudio 创建开发机

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106163112.png)

-  选择镜像 ： Cuda11.7-conda 
-  选择 GPU 资源: A100 (1/4) 

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106163423.png)

-  稍等一会，开发机就会准备好

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106163605.png)

-  熟悉一下开发机的工作台

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106163737.png)

-  左上角是可以切换 `JupyterLab`、`终端`和 `VScode`

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106164006.png)

-  新建一个 `terminal` 窗口，输入 `bash` 进入 conda 环境

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106164238.png)

-  使用命令

```shell
# 使用命令从本地 clone 一个已有的 `pytorch` 环境
conda create --name internlm-demo --clone=/root/share/conda_envs/internlm-base

# 然后使用以下命令激活环境
conda activate internlm-demo

# 安装依赖
# 升级pip
python -m pip install --upgrade pip

pip install modelscope==1.9.5
pip install transformers==4.35.2
pip install streamlit==1.24.0
pip install sentencepiece==0.1.99
pip install accelerate==0.24.1
```


## 模型下载

-  [InternStudio](https://studio.intern-ai.org.cn/) 平台的 `share` 目录下已经准备了全系列的 `InternLM` 模型

```shell
#复制模型
mkdir -p /root/model/Shanghai_AI_Laboratory
cp -r /root/share/temp/model_repos/internlm-chat-7b /root/model/Shanghai_AI_Laboratory
# -r 选项表示递归地复制目录及其内容
```

>  也可以使用 `modelscope` 中的 `snapshot_download` 函数下载模型，第一个参数为模型名称，参数 `cache_dir` 为模型的下载路径。

-  下载模型。在 `/root` 路径下新建目录 `model`，在目录下新建 `download.py` 文件，输入代码

```python
import torch
from modelscope import snapshot_download, AutoModel, AutoTokenizer
import os
model_dir = snapshot_download('Shanghai_AI_Laboratory/internlm-chat-7b', cache_dir='/root/model', revision='v1.0.3')
```

-  执行命令

```shell
python /root/model/download.py
```

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106210959.png)

## 代码准备


```shell
# 首先 `clone` 代码，在 `/root` 路径下新建 `code` 目录，然后切换路径, clone 代码
cd /root/code
git clone https://gitee.com/internlm/InternLM.git
```

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106210858.png)

```python
# 切换 commit 版本，与教程 commit 版本保持一致，可以让大家更好的复现。
cd InternLM
git checkout 3028f07cb79e5b1d7342f4ad8d11efad3fd13d17
```

-  将 `/root/code/InternLM/web_demo.py` 中 29 行和 33 行的模型更换为本地的 `/root/model/Shanghai_AI_Laboratory/internlm-chat-7b`。

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106210939.png)

## 终端运行

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106211038.png)

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106211134.png)

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106211246.png)

![image text](https://raw.githubusercontent.com/burningmysoul2077/Notes/main/ScreenShots/Datawhale%E7%BB%84%E9%98%9F%E5%AD%A6%E4%B9%A0/Pasted%20image%2020240106211549.png)
